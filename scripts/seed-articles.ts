/**
 * Seed Script: Generate 10,000 test articles
 * Run with: npx tsx scripts/seed-articles.ts
 */

import { Pool } from 'pg';
import { idGenerator } from '../lib/id-generator';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

// Hindi astrological topics and content snippets
const TOPICS = [
  'рд╢рдирд┐ рд╕рд╛рдврд╝реЗ рд╕рд╛рддреА', 'рд░рд╛рд╣реБ рдХреЗрддреБ рдЧреЛрдЪрд░', 'рдордВрдЧрд▓ рджреЛрд╖', 'рдХрд╛рд▓рд╕рд░реНрдк рдпреЛрдЧ', 'рдЧрдЬрдХреЗрд╕рд░реА рдпреЛрдЧ',
  'рд░рд╛рдЬрдпреЛрдЧ', 'рдзрди рдпреЛрдЧ', 'рд╡рд┐рд╡рд╛рд╣ рдпреЛрдЧ', 'рд╕рдВрддрд╛рди рдпреЛрдЧ', 'рдЧреНрд░рд╣рдг рдХрд╛ рдкреНрд░рднрд╛рд╡',
  'рдирд╡рдЧреНрд░рд╣ рдкреВрдЬрд╛', 'рд░реБрджреНрд░рд╛рднрд┐рд╖реЗрдХ', 'рдорд╣рд╛рдореГрддреНрдпреБрдВрдЬрдп рдЬрд╛рдк', 'рд╣рдиреБрдорд╛рди рдЪрд╛рд▓реАрд╕рд╛', 'рд╢рд┐рд╡ рдкреВрдЬрд╛',
  'рд╡рд╛рд╕реНрддреБ рд╢рд╛рд╕реНрддреНрд░', 'рджрд┐рд╢рд╛ рдЬреНрдЮрд╛рди', 'рдЧреГрд╣ рдкреНрд░рд╡реЗрд╢ рдореБрд╣реВрд░реНрдд', 'рд╡реНрдпрд╛рдкрд╛рд░ рдореБрд╣реВрд░реНрдд', 'рд╡рд┐рд╡рд╛рд╣ рдореБрд╣реВрд░реНрдд',
  'рдореЗрд╖ рд░рд╛рд╢рд┐рдлрд▓', 'рд╡реГрд╖ рд░рд╛рд╢рд┐рдлрд▓', 'рдорд┐рдереБрди рд░рд╛рд╢рд┐рдлрд▓', 'рдХрд░реНрдХ рд░рд╛рд╢рд┐рдлрд▓', 'рд╕рд┐рдВрд╣ рд░рд╛рд╢рд┐рдлрд▓',
  'рдХрдиреНрдпрд╛ рд░рд╛рд╢рд┐рдлрд▓', 'рддреБрд▓рд╛ рд░рд╛рд╢рд┐рдлрд▓', 'рд╡реГрд╢реНрдЪрд┐рдХ рд░рд╛рд╢рд┐рдлрд▓', 'рдзрдиреБ рд░рд╛рд╢рд┐рдлрд▓', 'рдордХрд░ рд░рд╛рд╢рд┐рдлрд▓'
];

const CONTENT_TEMPLATES = [
  `<p>рд╡реИрджрд┐рдХ рдЬреНрдпреЛрддрд┐рд╖ рдореЗрдВ {topic} рдХрд╛ рд╡рд┐рд╢реЗрд╖ рдорд╣рддреНрд╡ рд╣реИред рдпрд╣ рдЬрд╛рддрдХ рдХреЗ рдЬреАрд╡рди рдкрд░ рдЧрд╣рд░рд╛ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓рддрд╛ рд╣реИред</p>
   <h3>рдореБрдЦреНрдп рдкреНрд░рднрд╛рд╡</h3>
   <p>рдЧреНрд░рд╣реЛрдВ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдпрд╣ рдпреЛрдЧ рд╢реБрдн рдпрд╛ рдЕрд╢реБрдн рдлрд▓ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╡рд┐рджреНрд╡рд╛рди рдЬреНрдпреЛрддрд┐рд╖рд┐рдпреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдЗрд╕рдХрд╛ рдкреНрд░рднрд╛рд╡ рд╡реНрдпрдХреНрддрд┐ рдХреЗ рдХрд░реНрдо рдФрд░ рднрд╛рдЧреНрдп рджреЛрдиреЛрдВ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред</p>
   <h3>рдЙрдкрд╛рдп</h3>
   <p>рдЗрд╕ рдкреНрд░рднрд╛рд╡ рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖ рдордВрддреНрд░ рдЬрд╛рдк, рджрд╛рди рдФрд░ рдкреВрдЬрд╛ рдХрд╛ рд╡рд┐рдзрд╛рди рд╣реИред рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЗрди рдЙрдкрд╛рдпреЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдиреЗ рд╕реЗ рд▓рд╛рдн рдорд┐рд▓рддрд╛ рд╣реИред</p>`,
  
  `<p>рдЖрдЬ рд╣рдо {topic} рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╡рд┐рд╕реНрддреГрдд рдЪрд░реНрдЪрд╛ рдХрд░реЗрдВрдЧреЗред рдпрд╣ рд╡рд┐рд╖рдп рдкреНрд░рд╛рдЪреАрди рдЧреНрд░рдВрдереЛрдВ рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╣реИред</p>
   <h3>рд╢рд╛рд╕реНрддреНрд░реАрдп рджреГрд╖реНрдЯрд┐рдХреЛрдг</h3>
   <p>рдмреГрд╣рддреНрдкрд░рд╛рд╢рд░ рд╣реЛрд░рд╛ рд╢рд╛рд╕реНрддреНрд░ рдореЗрдВ рдЗрд╕ рд╡рд┐рд╖рдп рдкрд░ рд╡рд┐рд╕реНрддреГрдд рд╡рд░реНрдгрди рдорд┐рд▓рддрд╛ рд╣реИред рдорд╣рд░реНрд╖рд┐ рдкрд░рд╛рд╢рд░ рдиреЗ рдЗрд╕рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдкрд╣рд▓реБрдУрдВ рдХреЛ рд╕реНрдкрд╖реНрдЯ рдХрд┐рдпрд╛ рд╣реИред</p>
   <blockquote>рдпреЛрдЧрдХрд╛рд░рдХ рдЧреНрд░рд╣ рдЬрдм рд╢реБрдн рд╕реНрдерд╛рди рдореЗрдВ рд╣реЛрдВ рддреЛ рдЬрд╛рддрдХ рдХреЛ рд░рд╛рдЬрдпреЛрдЧ рдХреА рдкреНрд░рд╛рдкреНрддрд┐ рд╣реЛрддреА рд╣реИред</blockquote>
   <p>рдЗрд╕ рд╕рд┐рджреНрдзрд╛рдВрдд рдХреЛ рд╕рдордЭрдирд╛ рдЕрддреНрдпрдВрдд рдЖрд╡рд╢реНрдпрдХ рд╣реИред</p>`,

  `<p>{topic} рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬреНрдпреЛрддрд┐рд╖реАрдп рдЕрд╡рдзрд╛рд░рдгрд╛ рд╣реИ рдЬреЛ рдЬрд╛рддрдХ рдХреЗ рднрд╡рд┐рд╖реНрдп рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреА рд╣реИред</p>
   <h3>рдЧрдгрдирд╛ рд╡рд┐рдзрд┐</h3>
   <p>рдХреБрдВрдбрд▓реА рдореЗрдВ рдЧреНрд░рд╣реЛрдВ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЗрд╕рдХреА рдЧрдгрдирд╛ рдХреА рдЬрд╛рддреА рд╣реИред рдЬрдиреНрдо рд╕рдордп рдФрд░ рд╕реНрдерд╛рди рдХрд╛ рд╕рдЯреАрдХ рдЬреНрдЮрд╛рди рдЖрд╡рд╢реНрдпрдХ рд╣реИред</p>
   <h3>рдлрд▓рд╛рджреЗрд╢</h3>
   <p>рд╡рд┐рднрд┐рдиреНрди рднрд╛рд╡реЛрдВ рдореЗрдВ рдЧреНрд░рд╣реЛрдВ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рд╕реЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдлрд▓ рдорд┐рд▓рддреЗ рд╣реИрдВред рджрд╢рд╛ рдФрд░ рдЧреЛрдЪрд░ рдХреЗ рд╕рд╛рде рдЗрд╕рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред</p>`
];

const STATUSES = ['DRAFT', 'PUBLISHED', 'UNLISTED'];
const TAGS = ['рдЬреНрдпреЛрддрд┐рд╖', 'рд╡рд╛рд╕реНрддреБ', 'рд░рд╛рд╢рд┐рдлрд▓', 'рдЙрдкрд╛рдп', 'рдордВрддреНрд░', 'рдкреВрдЬрд╛', 'рдЧреНрд░рд╣', 'рдирдХреНрд╖рддреНрд░'];

function randomFrom<T>(arr: T[]): T {
  return arr[Math.floor(Math.random() * arr.length)];
}

function randomTags(): string[] {
  const count = Math.floor(Math.random() * 3) + 1;
  const selected: string[] = [];
  for (let i = 0; i < count; i++) {
    const tag = randomFrom(TAGS);
    if (!selected.includes(tag)) selected.push(tag);
  }
  return selected;
}

function generateArticle(index: number) {
  const topic = randomFrom(TOPICS);
  const template = randomFrom(CONTENT_TEMPLATES);
  const content = template.replace(/{topic}/g, topic);
  const status = randomFrom(STATUSES);
  
  // Spread created_at over last 2 years
  const daysAgo = Math.floor(Math.random() * 730);
  const createdAt = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
  
  return {
    id: idGenerator.nextId(),
    title_hindi: `${topic} - рд╡рд┐рд╕реНрддреГрдд рд╡рд┐рд╢реНрд▓реЗрд╖рдг #${index + 1}`,
    content_hindi: content,
    slug: `article-${index + 1}-${Date.now()}`,
    status,
    tags: randomTags(),
    created_at: createdAt,
    published_at: status === 'PUBLISHED' ? createdAt : null,
  };
}

async function seed() {
  const BATCH_SIZE = 500;
  const TOTAL = 10000;
  
  console.log(`ЁЯМ▒ Seeding ${TOTAL} articles...`);
  console.time('Total time');

  for (let batch = 0; batch < TOTAL / BATCH_SIZE; batch++) {
    const articles = [];
    for (let i = 0; i < BATCH_SIZE; i++) {
      articles.push(generateArticle(batch * BATCH_SIZE + i));
    }

    // Bulk insert using VALUES
    const values: any[] = [];
    const placeholders: string[] = [];
    
    articles.forEach((article, idx) => {
      const offset = idx * 7;
      placeholders.push(`($${offset + 1}, $${offset + 2}, $${offset + 3}, $${offset + 4}, $${offset + 5}, $${offset + 6}, $${offset + 7})`);
      values.push(
        article.id,
        article.title_hindi,
        article.content_hindi,
        article.slug,
        article.status,
        article.tags,
        article.created_at
      );
    });

    const sql = `
      INSERT INTO posts (id, title_hindi, content_hindi, slug, status, tags, created_at)
      VALUES ${placeholders.join(', ')}
      ON CONFLICT (id) DO NOTHING
    `;

    await pool.query(sql, values);
    console.log(`  тЬЕ Batch ${batch + 1}/${TOTAL / BATCH_SIZE} (${(batch + 1) * BATCH_SIZE} articles)`);
  }

  console.timeEnd('Total time');
  console.log('ЁЯОЙ Done!');
  
  // Show count
  const result = await pool.query('SELECT COUNT(*) FROM posts');
  console.log(`ЁЯУК Total articles in DB: ${result.rows[0].count}`);
  
  await pool.end();
}

seed().catch(console.error);
